name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"
  IMAGE_NAME: rag-qa-system

jobs:

  # ── Job 1: Lint ─────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install lint tools
        run: pip install ruff

      - name: Run ruff linter
        run: ruff check src/ app/ tests/ --ignore E501

      - name: Run ruff formatter check
        run: ruff format --check src/ app/ tests/

  # ── Job 2: Tests ────────────────────────────────────────────────────────────
  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    needs: lint

    env:
      OPENAI_API_KEY: sk-test-placeholder   # mocked in tests; no real calls made

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install \
            langchain==0.3.25 \
            langchain-openai==0.3.16 \
            langchain-community==0.3.24 \
            langchain-text-splitters==0.3.8 \
            openai==1.82.0 \
            faiss-cpu==1.10.0 \
            "numpy>=2.0.0" \
            fastapi==0.115.12 \
            uvicorn==0.34.3 \
            python-dotenv==1.1.0 \
            pypdf==5.5.0 \
            rank-bm25==0.2.2 \
            sentence-transformers==3.0.1 \
            pytest==8.3.5 \
            pytest-cov \
            httpx

      - name: Run tests with coverage
        run: |
          pytest tests/ \
            --cov=src \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-fail-under=70 \
            -v

      - name: Upload coverage report
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false

  # ── Job 3: Docker Build ─────────────────────────────────────────────────────
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false      # set to true + add registry login for production push
          tags: ${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Smoke test container
        run: |
          docker run --rm \
            -e OPENAI_API_KEY=sk-placeholder \
            ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            python -c "from app.main import app; print('App imports OK')"

  # ── Job 4: Security Scan (main branch only) ─────────────────────────────────
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Run pip-audit
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt --ignore-vuln PYSEC-2022-42969 || true
